<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Storage — Enhanced Single File (50 features)</title>
<style>
  /* ========== BASE THEME (unchanged core styles kept) ========== */
  :root{
    --max-width:1200px;
    --card-size:220px;
    --panel-radius:14px;
    --glass-blur:10px;
    --font-family: Inter, "Segoe UI", system-ui, -apple-system, Arial;
    --bg: #000;
    --panel-bg: rgba(255,255,255,0.03);
    --panel-strong: rgba(255,255,255,0.04);
    --accent: #ff4c4c;
    --accent2: #ff9b9b;
    --muted: #bdbdbd;
    --text: #ffffff;
    --card-bg: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
    --glow: rgba(255,255,255,0.10);
    --radius:12px;
    --glow-strength:0.10;
    --control-bg: rgba(255,255,255,0.03);
  }
  body{margin:0;font-family:var(--font-family);background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
  .app-root{position:relative;z-index:2;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
  .container{width:100%;max-width:var(--max-width);display:flex;flex-direction:column;gap:12px}
  .header{display:flex;justify-content:space-between;align-items:center;padding:8px 4px}
  .title{font-size:20px;font-weight:800;color:var(--accent)}
  .controls{display:flex;gap:8px;align-items:center}
  .control-btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#120707;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .control-btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
  .grid-wrap{background:linear-gradient(180deg,var(--panel-bg),var(--panel-strong));padding:12px;border-radius:var(--panel-radius);border:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(var(--glass-blur));height:calc(100vh - 160px);display:flex;flex-direction:column;gap:12px;overflow:hidden}
  .top-row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px}
  .left-controls{display:flex;gap:8px;align-items:center}
  .search-input{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);min-width:260px}
  .filter-select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
  #fileList{flex:1;display:grid;grid-template-columns:repeat(5,1fr);grid-auto-rows:var(--card-size);gap:12px;padding:8px 12px;overflow:auto}
  #fileList.list{ display:block;padding:8px 12px }
  .file-card{height:100%;background:var(--card-bg);border-radius:var(--radius);padding:10px;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;gap:8px;transition:transform .12s, box-shadow .12s;border:1px solid rgba(255,255,255,0.02);position:relative;min-width:0;box-sizing:border-box}
  .preview-wrap{width:100%;height:calc(var(--card-size) - 96px);display:flex;align-items:center;justify-content:center;background:#060606;border-radius:8px;overflow:hidden}
  .preview-wrap img{width:100%;height:100%;object-fit:contain;display:block}
  .file-name{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:0 4px}
  .file-actions{display:flex;gap:8px;align-items:center;justify-content:center;padding:0 4px;width:100%}
  .file-actions button, .file-actions a{flex:0 0 30%;padding:6px 6px;border-radius:8px;border:none;background:var(--text);color:#111;font-weight:700;cursor:pointer;text-decoration:none;text-align:center;font-size:13px}
  .file-actions button.del{background:#9b1f1f;color:#fff}
  .select-checkbox{position:absolute;left:10px;top:10px;background:rgba(0,0,0,0.25);padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;display:flex;align-items:center;justify-content:center}
  #pagination{display:flex;gap:8px;justify-content:center;padding:10px;align-items:center}
  #progressContainer{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--panel-strong);padding:12px;border-radius:10px;display:none;z-index:90;border:1px solid rgba(255,255,255,0.03)}
  #imgModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:95}
  #imgModal img{max-width:92%;max-height:92%;border-radius:12px}
  #pasteModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(960px,95%);max-height:85vh;overflow:auto;background:linear-gradient(180deg,var(--panel-bg),var(--panel-strong));padding:12px;border-radius:12px;display:none;z-index:100;border:1px solid rgba(255,255,255,0.03)}
  #pasteModal textarea{width:100%;min-height:320px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);resize:vertical}
  .settings-panel{position:fixed;right:-520px;top:0;height:100%;width:480px;background:linear-gradient(180deg,var(--panel-bg),var(--panel-strong));backdrop-filter:blur(var(--glass-blur));padding:18px;border-left:1px solid rgba(255,255,255,0.03);z-index:100;transition:right .28s;overflow:auto}
  .settings-panel.open{right:0}
  .theme-option{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.02);margin-bottom:10px}
  .theme-option.active{outline:2px solid rgba(255,255,255,0.06)}
  .toast{position:fixed;right:20px;bottom:20px;background:rgba(0,0,0,0.8);color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.6);z-index:999}
  .hidden{display:none !important}
  /* responsive */
  @media (max-width:1200px){ #fileList{grid-template-columns:repeat(4,1fr)} .settings-panel{width:360px} }
  @media (max-width:920px){ #fileList{grid-template-columns:repeat(3,1fr)} .settings-panel{width:320px} }
  @media (max-width:640px){ #fileList{grid-template-columns:repeat(2,1fr)} .login-box{width:320px} .top-row { flex-direction: column; align-items: stretch; gap:8px } }
</style>
</head>
<body>
<canvas id="bgCanvas" aria-hidden="true" style="position:fixed;inset:0;z-index:0"></canvas>

<div class="app-root">
  <div class="container">
    <!-- LOGIN -->
    <div id="loginPage" role="dialog" aria-modal="true" aria-label="Login" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:110;">
      <div class="login-box" style="width:360px;background:linear-gradient(180deg,var(--panel-bg),var(--panel-strong));padding:30px;border-radius:var(--panel-radius);backdrop-filter:blur(var(--glass-blur));border:1px solid rgba(255,255,255,0.03);text-align:center">
        <h2 style="margin:0 0 10px;color:var(--accent);font-size:20px">Enter View ID</h2>
        <input id="viewId" class="input" type="password" placeholder="Input view id" aria-label="View ID" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);outline:none;margin-bottom:10px"/>
        <div class="login-actions" style="margin-top:8px">
          <button id="loginBtn" class="btn primary">Log In</button>
        </div>
        <div id="loginError" class="login-error" role="alert" style="color:#ff9b9b;margin-top:8px;min-height:18px"></div>
      </div>
    </div>

    <!-- APP -->
    <div id="appPage" style="display:none" aria-live="polite">
      <div class="header" role="banner">
        <div class="title">My Storage</div>
        <div class="controls" role="navigation" aria-label="Top controls">
          <input id="fileInput" type="file" style="display:none" multiple />
          <button id="chooseBtn" class="control-btn" title="Choose file(s)">Choose</button>
          <button id="uploadBtn" class="control-btn" title="Upload selected file">Upload</button>
          <button id="pasteHtmlBtn" class="control-btn secondary" title="Paste HTML into storage">Paste HTML</button>
          <button id="dropZoneToggle" class="control-btn secondary" title="Toggle drag-drop upload area">DragDrop</button>
          <button id="refreshBtn" class="control-btn secondary" title="Reload file list">Refresh</button>
          <button id="settingsBtn" class="control-btn secondary" title="Open settings">Settings</button>
          <button id="demoToggle" class="control-btn secondary" title="Toggle demo mode">DemoMode</button>
          <button id="logoutBtn" class="control-btn secondary" title="Logout">Logout</button>
        </div>
      </div>

      <div class="grid-wrap" role="main">
        <div class="top-row" role="region" aria-label="File controls">
          <div class="left-controls">
            <input id="search" class="search-input" placeholder="Search files, tags, type..." aria-label="Search files">
            <select id="typeFilter" class="filter-select" title="Filter by type" aria-label="Filter by type">
              <option value="all">All types</option>
              <option value="images">Images</option>
              <option value="documents">Documents</option>
              <option value="audio">Audio</option>
              <option value="video">Video</option>
              <option value="archives">Archives</option>
            </select>
            <select id="sortSelect" class="filter-select" title="Sort by" aria-label="Sort files">
              <option value="name_asc">Name ↑</option>
              <option value="name_desc">Name ↓</option>
              <option value="newest">Newest</option>
              <option value="oldest">Oldest</option>
              <option value="size_desc">Size ↓</option>
              <option value="size_asc">Size ↑</option>
            </select>
            <label style="display:flex;align-items:center;gap:6px;color:var(--muted)"><input id="compactToggle" type="checkbox" style="margin-right:6px">Compact</label>
          </div>

          <div style="display:flex;align-items:center;gap:8px">
            <div class="small-muted" id="selectionCount" style="min-width:80px;text-align:right">0 selected</div>
            <button id="multiDelete" class="control-btn secondary" title="Delete selected">Delete</button>
            <button id="multiDownload" class="control-btn secondary" title="Download selected">Download ZIP</button>
            <button id="selectAllPage" class="control-btn secondary" title="Select all on page">Select Page</button>
          </div>
        </div>

        <div id="dropZone" style="display:none;border:2px dashed rgba(255,255,255,0.06);padding:12px;border-radius:10px;text-align:center;color:var(--muted);margin:8px 12px;">Drop files here to upload</div>

        <div id="fileList" aria-live="polite" tabindex="0"></div>
        <div id="pagination"></div>
      </div>
    </div>
  </div>
</div>

<!-- progress -->
<div id="progressContainer" role="status" aria-hidden="true">
  <progress id="uploadProgress" max="100" value="0" style="width:320px"></progress>
  <div id="progressText" style="color:var(--muted);text-align:center;margin-top:8px">0%</div>
  <div id="uploadError" style="color:#ff8b8b;margin-top:8px"></div>
</div>

<!-- image/modal preview -->
<div id="imgModal" aria-hidden="true"><button id="closeImg" aria-label="Close image" style="position:absolute;top:18px;right:20px;padding:8px 12px;border-radius:8px;border:none;background:var(--text);color:#120707;font-weight:700;cursor:pointer;z-index:96">Close</button><div id="previewContent" style="max-width:92%;max-height:92%;border-radius:8px;background:#000;padding:12px;overflow:auto"></div></div>

<!-- paste HTML modal -->
<div id="pasteModal" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="font-weight:700;color:var(--accent)">Paste HTML</div>
    <button id="closePaste" class="btn ghost">Close</button>
  </div>
  <div style="margin-bottom:8px" class="small-muted">Paste a full HTML document (including &lt;!doctype html&gt;) or fragment. Enter a filename then Save.</div>
  <input id="pasteFilename" type="text" placeholder="filename.html (optional)" />
  <textarea id="pasteArea" placeholder="Paste your HTML here..."></textarea>
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="previewPaste" class="btn secondary">Preview</button>
    <button id="savePaste" class="btn primary">Save as file</button>
  </div>
  <div style="height:8px"></div>
  <iframe id="pastePreviewFrame" style="width:100%;height:320px;border:1px solid rgba(255,255,255,0.04);display:none;border-radius:8px"></iframe>
</div>

<!-- details modal -->
<div id="detailsModal" role="dialog" aria-modal="true" aria-label="File details" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,var(--panel-bg),var(--panel-strong));padding:18px;border-radius:12px;z-index:101;border:1px solid rgba(255,255,255,0.03);max-width:90%;max-height:90%;overflow:auto">
  <h4 style="margin:0 0 8px;color:var(--accent)">File details</h4>
  <div id="detailsContent" style="font-size:13px;color:var(--muted)"></div>
  <div style="height:12px"></div>
  <button id="closeDetails" class="btn ghost">Close</button>
</div>

<!-- context menu -->
<div id="ctxMenu" role="menu" aria-hidden="true" style="position:fixed;display:none;background:var(--panel-strong);padding:6px;border-radius:8px;z-index:120;border:1px solid rgba(255,255,255,0.04)"></div>

<!-- settings -->
<div id="settingsPanel" class="settings-panel" aria-hidden="true">
  <h3 style="margin:0 0 10px;color:var(--muted)">Settings & Customization</h3>
  <div style="margin-bottom:8px">Pick a theme</div>
  <div class="theme-option" data-theme="black"><div class="theme-swatch" style="background:black;width:36px;height:24px;border-radius:6px;border:1px solid rgba(255,255,255,0.06)"></div><div>Black</div></div>
  <div class="theme-option" data-theme="white"><div class="theme-swatch" style="background:#f6f6f6;border-radius:6px;border:1px solid #ddd;width:36px;height:24px"></div><div>White</div></div>
  <div style="margin-top:12px" class="small-muted">Primary accent</div>
  <input id="accentColor" type="color" value="#ff4c4c" aria-label="Primary accent color" style="width:100%;margin-top:8px">
  <div style="height:12px"></div>
  <label style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <span class="small-muted">Rounded corners</span>
    <input id="toggleRadius" type="checkbox" checked aria-label="Rounded corners">
  </label>
  <label style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <span class="small-muted">Glow effect</span>
    <input id="toggleGlow" type="checkbox" checked aria-label="Glow effect">
  </label>
  <div style="height:12px"></div>
  <button id="saveSettings" class="btn primary" style="width:100%">Save Settings</button>
  <div style="height:8px"></div>
  <button id="exportSettings" class="btn secondary" style="width:100%">Export Settings</button>
  <div style="height:8px"></div>
  <button id="importSettings" class="btn ghost" style="width:100%">Import Settings</button>
  <div style="height:8px"></div>
  <button id="closeSettings" class="btn ghost" style="width:100%">Close</button>
</div>

<!-- toast container -->
<div id="toastContainer" style="position:fixed;right:20px;bottom:20px;z-index:9999"></div>

<script type="module">
/* ----------------------------------------------------------------------
   Enhanced single-file app (plain HTML/JS/CSS) — 50 features implemented
   Sections:
    1) Config & state
    2) Utility helpers (format, debounce, toasts, zip)
    3) Settings persistence
    4) Supabase client (kept intact)
    5) Upload queue + worker
    6) File listing + demo data generator
    7) Previews (image/pdf/audio/video/text/markdown)
    8) Multi-select, tags, favorites, folders (virtual)
    9) Keyboard shortcuts & context menu
   ---------------------------------------------------------------------- */

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

/* ========== 1) CONFIG & STATE ========== */
const SUPABASE_URL = 'https://dnuvhvcnwmbjttmitcwr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRudXZodmNud21ianR0bWl0Y3dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3OTg1NDQsImV4cCI6MjA3NTM3NDU0NH0.KhDCEqwTX-1h2EUT7cy3AvoJoTt7ElCD80Boxf-uVHI';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabase = supabase;

const BUCKET = 'my-storage';
const FOLDER = 'uploads/';
const VIEW_ID = '12321';

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

let currentPage = 1;
let itemsPerPage = 25;
let DEMO_MODE = false; // toggleable
const SETTINGS_KEY = 'my_storage_settings_v4';
const defaultSettings = {
  theme: 'black',
  accent: '#ff4c4c',
  radiusOn: true,
  glowOn: true,
  bgMode: 'particles',
  particleDensity: 120,
  font: "Inter, system-ui, -apple-system, 'Segoe UI', Arial",
  pageSize: 25,
  viewMode: 'grid',
  compactMode: false,
  maxFileSizeMB: 200,
  language: 'en',
  demoMode: false
};

function loadSettings(){ try{ const raw = localStorage.getItem(SETTINGS_KEY); return raw ? {...defaultSettings, ...JSON.parse(raw)} : {...defaultSettings}; }catch(e){ return {...defaultSettings}; } }
function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }

let SETTINGS = loadSettings();

/* ========== 2) UTILITY HELPERS ========== */
function fmtBytes(n){
  if(n === 0) return '0 B';
  const sizes = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(n)/Math.log(1024));
  return `${(n/Math.pow(1024,i)).toFixed(i===0?0:2)} ${sizes[i]}`;
}
function fmtDate(iso){ const d = new Date(iso); return d.toLocaleString(); }
function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
function toast(msg, opts={timeout:3000}){ const el = document.createElement('div'); el.className='toast'; el.textContent = msg; $('#toastContainer').appendChild(el); setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),400); }, opts.timeout); }

/* client-side ZIP (simple via JSZip) - minimal implementation fallback */
async function zipAndDownload(files){ // files: [{name, blob}]
  // Try dynamic import of JSZip from CDN; fallback to simple sequential downloads if blocked
  try{
    const { default: JSZip } = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js');
    const zip = new JSZip();
    for(const f of files){ zip.file(f.name, f.blob || f.data); }
    const content = await zip.generateAsync({type:'blob'});
    const url = URL.createObjectURL(content);
    const a = document.createElement('a'); a.href = url; a.download = 'download.zip'; a.click(); URL.revokeObjectURL(url);
  }catch(e){
    // fallback: if only one file, download it; otherwise show message
    if(files.length===1){ const f=files[0]; const url = URL.createObjectURL(f.blob||f.data); const a=document.createElement('a'); a.href=url; a.download=f.name; a.click(); URL.revokeObjectURL(url); }
    else toast('ZIP failed (no JSZip). Will download files one-by-one.', {timeout:4000});
    for(const f of files){ const url = URL.createObjectURL(f.blob||f.data); const a=document.createElement('a'); a.href=url; a.download=f.name; a.click(); URL.revokeObjectURL(url); }
  }
}

function uniqueId(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,9); }

/* ========== 3) SETTINGS PERSIST & APPLY ========== */
function applySettings(s){
  document.body.classList.remove('theme-black','theme-white','theme-red','theme-blue','theme-green','theme-purple','theme-gold','theme-gray');
  if(s.theme) document.body.classList.add('theme-'+s.theme);
  document.documentElement.style.setProperty('--accent', s.accent);
  document.documentElement.style.setProperty('--radius', s.radiusOn ? '12px' : '4px');
  if(s.glowOn) document.body.classList.remove('no-glow'); else document.body.classList.add('no-glow');
  itemsPerPage = s.pageSize || itemsPerPage;
  document.getElementById('fileList').classList.toggle('list', s.viewMode === 'list');
  document.getElementById('fileList').classList.toggle('compact', s.compactMode);
  DEMO_MODE = !!s.demoMode;
}
function populateSettingsUI(s){
  document.querySelectorAll('.theme-option').forEach(el => el.classList.toggle('active', el.dataset.theme === s.theme));
  $('#accentColor').value = s.accent;
  $('#toggleRadius').checked = s.radiusOn;
  $('#toggleGlow').checked = s.glowOn;
}

/* ========== 4) SUPABASE ACTIONS & HELPERS ========== */
function showLoginError(msg){ $('#loginError').textContent = msg || ''; }
function showUploadError(msg){ $('#uploadError').textContent = msg || ''; }

async function supabaseGetPublicUrl(path){
  try{ const { data } = supabase.storage.from(BUCKET).getPublicUrl(path); return data?.publicUrl || null; }catch(e){ return null; }
}

/* ========== 5) UPLOAD QUEUE + WORKER ========== */
const uploadQueue = [];
let uploading = false;

function enqueueUpload(file, metadata={}){
  const id = uniqueId('upload');
  uploadQueue.push({ id, file, metadata, status:'pending', progress:0, canceled:false });
  processQueue();
  renderUploadQueueUI();
}

async function processQueue(){
  if(uploading) return;
  uploading = true;
  while(uploadQueue.length){
    const item = uploadQueue[0];
    if(item.canceled){ uploadQueue.shift(); continue; }
    try{
      $('#progressContainer').style.display = 'block';
      $('#uploadProgress').value = 0;
      $('#progressText').textContent = `Uploading ${item.file.name}`;
      // Use fetch with progress is not trivial w/ Supabase; rely on supabase storage SDK (no progress) but simulate progress
      for(let p=0;p<=80;p+=20){ $('#uploadProgress').value = p; $('#progressText').textContent = `${p}%`; await new Promise(r=>setTimeout(r,60)); }
      const path = `${FOLDER}${item.file.name}`;
      const { error } = await supabase.storage.from(BUCKET).upload(path, item.file, { upsert: true });
      if(error) throw error;
      $('#uploadProgress').value = 100; $('#progressText').textContent = `100%`;
      toast(`Uploaded ${item.file.name}`, {timeout:2000});
      uploadQueue.shift();
      await listFiles();
      $('#progressContainer').style.display = 'none';
    }catch(err){
      $('#progressContainer').style.display = 'none';
      showUploadError('Upload failed: ' + (err.message || err));
      console.error(err);
      item.status = 'error';
      uploadQueue.shift();
    }
  }
  uploading = false;
  renderUploadQueueUI();
}

function renderUploadQueueUI(){
  // minimal: show active uploads as toasts
  const q = uploadQueue.slice(0,4);
  // remove old small toasts, then re-add
  const c = $('#toastContainer');
  c.innerHTML = '';
  q.forEach(it => {
    const el = document.createElement('div'); el.className='toast'; el.textContent = `${it.status==='pending'?'Uploading':'Queued'}: ${it.file.name}`; c.appendChild(el);
  });
}

/* ========== 6) FILE LISTING + DEMO DATA ========== */

/* local cache (IndexedDB simple wrapper using localforage style using IndexedDB directly) */
const DB_NAME = 'my_storage_cache';
function idbOpen(){
  return new Promise((resolve, reject)=>{
    const r = indexedDB.open(DB_NAME, 1);
    r.onupgradeneeded = ()=> { r.result.createObjectStore('files', { keyPath:'name' }); };
    r.onsuccess = ()=> resolve(r.result);
    r.onerror = ()=> reject(r.error);
  });
}
async function cacheFiles(files){
  try{
    const db = await idbOpen();
    const tx = db.transaction('files','readwrite');
    const store = tx.objectStore('files');
    store.clear();
    for(const f of files) store.put(f);
    return tx.complete;
  }catch(e){ console.warn('cache failed', e); }
}
async function getCachedFiles(){
  try{
    const db = await idbOpen();
    const tx = db.transaction('files','readonly'); const store = tx.objectStore('files');
    return new Promise((res,rej)=>{ const req = store.getAll(); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); });
  }catch(e){ return []; }
}

function genDemoFiles(n=500){
  const arr = [];
  const types = ['html','png','jpg','pdf','mp3','mp4','zip','txt','md','svg'];
  for(let i=0;i<n;i++){
    const ext = types[i % types.length];
    const name = `demo-${(i+1).toString().padStart(4,'0')}.${ext}`;
    arr.push({
      name,
      size: Math.floor(Math.random()*5_000_000) + 1024,
      created_at: new Date(Date.now() - i*3600*1000).toISOString(),
      metadata: { tags: ['demo', ext], favorite: (i%17===0), folder: i%10===0?`folder-${(i%5)+1}`:null }
    });
  }
  return arr;
}

let lastFetchedFiles = [];
async function listFiles(){
  const container = $('#fileList');
  container.innerHTML = '';
  $('#pagination').innerHTML = '';

  try{
    let files;
    if(DEMO_MODE || SETTINGS.demoMode){
      files = genDemoFiles(500);
    } else {
      // use supabase to list
      const { data: sfiles, error } = await supabase.storage.from(BUCKET).list(FOLDER, { limit: 2000 });
      if(error) throw error;
      files = (sfiles || []).map(f=>({
        name: f.name,
        size: f.size || 0,
        created_at: f.updated_at || f.created_at || new Date().toISOString(),
        metadata: f.metadata || {}
      }));
    }

    // cache for offline
    cacheFiles(files).catch(()=>{});
    lastFetchedFiles = files;

    // apply search/filter/sort
    const q = ($('#search').value||'').trim().toLowerCase();
    const typeFilter = $('#typeFilter').value;
    const sortVal = $('#sortSelect').value;

    let filtered = files.filter(f=>{
      if(q){
        if(!(f.name.toLowerCase().includes(q) || (f.metadata?.tags||[]).join(' ').toLowerCase().includes(q))) return false;
      }
      if(typeFilter && typeFilter !== 'all'){
        const isImage = /\.(jpe?g|png|gif|webp|bmp|svg)$/i.test(f.name);
        const isAudio = /\.(mp3|wav|ogg)$/i.test(f.name);
        const isVideo = /\.(mp4|webm|mov|mkv)$/i.test(f.name);
        const isDoc = /\.(pdf|docx|txt|md|html)$/i.test(f.name);
        if(typeFilter === 'images' && !isImage) return false;
        if(typeFilter === 'audio' && !isAudio) return false;
        if(typeFilter === 'video' && !isVideo) return false;
        if(typeFilter === 'documents' && !isDoc) return false;
      }
      return true;
    });

    filtered.sort((a,b)=>{
      if(sortVal === 'name_asc') return a.name.localeCompare(b.name,{numeric:true});
      if(sortVal === 'name_desc') return b.name.localeCompare(a.name,{numeric:true});
      if(sortVal === 'newest') return new Date(b.created_at) - new Date(a.created_at);
      if(sortVal === 'oldest') return new Date(a.created_at) - new Date(b.created_at);
      if(sortVal === 'size_desc') return (b.size||0)-(a.size||0);
      if(sortVal === 'size_asc') return (a.size||0)-(b.size||0);
      return 0;
    });

    const totalPages = Math.max(1, Math.ceil(filtered.length / itemsPerPage));
    if(currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage-1)*itemsPerPage;
    const pageFiles = filtered.slice(start, start + itemsPerPage);

    // render cards
    for(const f of pageFiles){
      const filePath = `${FOLDER}${f.name}`;
      // attempt to get public url if not demo
      const url = DEMO_MODE ? `https://placehold.co/600x400?text=${encodeURIComponent(f.name)}` : await supabaseGetPublicUrl(filePath) || `https://placehold.co/600x400?text=${encodeURIComponent(f.name)}`;
      const isImage = /\.(jpe?g|png|gif|webp|bmp|svg)$/i.test(f.name);
      const isAudio = /\.(mp3|wav|ogg)$/i.test(f.name);
      const isVideo = /\.(mp4|webm|mov|mkv)$/i.test(f.name);
      const isPdf = /\.pdf$/i.test(f.name);
      const card = document.createElement('div');
      card.className = 'file-card';
      card.tabIndex = 0;
      card.dataset.name = f.name;
      card.innerHTML = `
        <div class="select-checkbox" title="Select"><input type="checkbox" aria-label="Select file" data-name="${f.name}"></div>
        <div class="preview-wrap" aria-hidden="${!isImage}">
          ${ isImage ? `<img data-src="${url}" alt="${f.name}" class="preview lazy">` : `<div style="font-size:36px;color:var(--muted)">${isPdf? '📄': (isAudio? '🎵': (isVideo? '🎞️':'📦'))}</div>` }
        </div>
        <div class="meta">
          <div class="file-name" title="${f.name}">${f.name}</div>
          <div class="file-meta-row" style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-size:12px;color:var(--muted)">${fmtBytes(f.size||0)}</div>
            <div style="font-size:12px;color:var(--muted)">${fmtDate(f.created_at||new Date().toISOString())}</div>
          </div>
          <div class="file-actions">
            <button class="del" data-name="${f.name}">Delete</button>
            <button class="rename" data-name="${f.name}">Rename</button>
            <a class="download" data-url="${url}" target="_blank" rel="noopener">Download</a>
          </div>
        </div>
      `;
      container.appendChild(card);
    }

    // pagination
    if(totalPages > 1){
      const pg = $('#pagination');
      const prev = document.createElement('button'); prev.className='btn small secondary'; prev.textContent='‹'; prev.disabled = currentPage===1;
      prev.addEventListener('click', ()=>{ currentPage = Math.max(1, currentPage-1); listFiles();});
      pg.appendChild(prev);

      for(let i=1;i<=totalPages;i++){
        const b = document.createElement('button'); b.className='btn small'; b.textContent = i;
        if(i===currentPage){ b.classList.add('active'); b.disabled = true; }
        b.addEventListener('click', ()=>{ currentPage = i; listFiles(); });
        pg.appendChild(b);
      }

      const next = document.createElement('button'); next.className='btn small secondary'; next.textContent='›'; next.disabled = currentPage===totalPages;
      next.addEventListener('click', ()=>{ currentPage = Math.min(totalPages, currentPage+1); listFiles();});
      pg.appendChild(next);
    }

    // lazy load images
    lazyLoadImages();

    updateSelectionCount();
  }catch(err){
    console.error(err);
    // try offline cache
    const cached = await getCachedFiles();
    if(cached && cached.length){
      lastFetchedFiles = cached;
      toast('Offline: showing cached files', {timeout:3000});
      DEMO_MODE = false;
      // render cached using a quick helper
      const prevPage = currentPage;
      currentPage = 1;
      const saved = cached.slice(0, itemsPerPage);
      $('#fileList').innerHTML = '';
      for(const f of saved){
        const div = document.createElement('div'); div.className='file-card';
        div.innerHTML = `<div class="preview-wrap"><div style="font-size:36px;color:var(--muted)">📄</div></div><div class="meta"><div class="file-name">${f.name}</div></div>`;
        $('#fileList').appendChild(div);
      }
      currentPage = prevPage;
    } else {
      $('#fileList').innerHTML = '<div style="padding:20px;color:var(--muted)">Failed to load files</div>';
    }
  }
}

/* ========== 7) PREVIEWS & MODALS ========== */
function lazyLoadImages(){
  const imgs = document.querySelectorAll('img.lazy');
  imgs.forEach(img=>{
    const src = img.dataset.src;
    if(!src) return;
    const io = new IntersectionObserver(entries=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          img.src = src;
          img.classList.remove('lazy');
          io.disconnect();
        }
      });
    });
    io.observe(img);
  });
}

function openPreview(name, url){
  const c = $('#previewContent'); c.innerHTML = '';
  if(/\.(jpe?g|png|gif|webp|bmp|svg)$/i.test(name)){
    const img = document.createElement('img'); img.src = url; img.alt = name; img.style.maxWidth = '100%'; img.style.maxHeight='80vh';
    c.appendChild(img);
  } else if(/\.pdf$/i.test(name)){
    const iframe = document.createElement('iframe'); iframe.src = url; iframe.style.width='80vw'; iframe.style.height='80vh'; c.appendChild(iframe);
  } else if(/\.(mp3|wav|ogg)$/i.test(name)){
    const audio = document.createElement('audio'); audio.src = url; audio.controls = true; c.appendChild(audio);
  } else if(/\.(mp4|webm|mov)$/i.test(name)){
    const video = document.createElement('video'); video.src=url; video.controls=true; video.style.maxWidth='80vw'; video.style.maxHeight='80vh'; c.appendChild(video);
  } else {
    // fetch text content if not binary (only for demo or public)
    fetch(url).then(r=>r.text()).then(t=>{
      const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.color='var(--muted)'; pre.textContent = t;
      c.appendChild(pre);
    }).catch(()=> {
      c.textContent = 'Preview not available';
    });
  }
  $('#imgModal').style.display = 'flex';
  $('#imgModal').setAttribute('aria-hidden','false');
}

$('#closeImg').addEventListener('click', ()=> { $('#imgModal').style.display='none'; $('#imgModal').setAttribute('aria-hidden','true'); });

/* ========== 8) BASIC FILE ACTIONS (delete/rename/copy url) ========== */
async function deleteFile(name){
  if(!confirm(`Delete "${name}"?`)) return;
  try{
    const { error } = await supabase.storage.from(BUCKET).remove([`${FOLDER}${name}`]);
    if(error) throw error;
    toast(`Deleted ${name}`, {timeout:2000});
    await listFiles();
  }catch(err){
    alert('Delete failed: '+(err.message||err));
    console.error(err);
  }
}

async function renameFile(oldName){
  const newName = prompt('Enter new name for:', oldName);
  if(!newName || newName === oldName) return;
  try{
    // collision detection
    if( (lastFetchedFiles||[]).find(f=>f.name === newName) ){
      if(!confirm('A file with that name exists. Add suffix to avoid overwrite?')) return;
      const idx = Date.now(); const uniq = `${newName.replace(/\.(?=[^.]+$)/,'-'+idx+'.')}`; // crude
      const { error } = await supabase.storage.from(BUCKET).move(`${FOLDER}${oldName}`, `${FOLDER}${uniq}`);
      if(error) throw error;
      toast(`Renamed to ${uniq}`, {timeout:2000});
    } else {
      const { error } = await supabase.storage.from(BUCKET).move(`${FOLDER}${oldName}`, `${FOLDER}${newName}`);
      if(error) throw error;
      toast(`Renamed ${oldName} → ${newName}`, {timeout:2000});
    }
    listFiles();
  }catch(err){
    alert('Rename failed: '+(err.message||err));
    console.error(err);
  }
}

/* copy to clipboard helper */
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); toast('Copied to clipboard'); }
  catch(e){ prompt('Copy URL (manual):', text); }
}

/* ========== 9) MULTI-SELECT & BATCH ACTIONS ========== */
function updateSelectionCount(){
  const checked = Array.from(document.querySelectorAll('#fileList input[type="checkbox"]:checked')).map(n=>n.dataset.name);
  $('#selectionCount').textContent = `${checked.length} selected`;
  return checked;
}

$('#fileList').addEventListener('click', async (e) => {
  const del = e.target.closest('button.del');
  if(del){ e.stopPropagation(); const name = del.dataset.name; if(DEMO_MODE) { toast('Demo mode: delete simulated'); } else await deleteFile(name); return; }
  const ren = e.target.closest('button.rename');
  if(ren){ e.stopPropagation(); renameFile(ren.dataset.name); return; }
  const img = e.target.closest('img.preview');
  if(img){
    const name = img.closest('.file-card').dataset.name;
    const url = img.src;
    openPreview(name, url);
    return;
  }
  // checkbox select toggles
  if(e.target.matches('#fileList input[type="checkbox"]')){
    updateSelectionCount();
    return;
  }
});

$('#selectAllPage').addEventListener('click', ()=>{
  const checkboxes = Array.from(document.querySelectorAll('#fileList input[type="checkbox"]'));
  const allChecked = checkboxes.every(cb=>cb.checked);
  checkboxes.forEach(cb=>cb.checked = !allChecked);
  updateSelectionCount();
});

$('#multiDelete').addEventListener('click', async ()=>{
  const checked = updateSelectionCount();
  if(!checked.length) return toast('No files selected');
  if(!confirm(`Delete ${checked.length} selected files?`)) return;
  for(const name of checked){
    if(DEMO_MODE) { toast(`Demo: deleted ${name}`); } else {
      try{ await supabase.storage.from(BUCKET).remove([`${FOLDER}${name}`]); }catch(e){ console.error(e); }
    }
  }
  listFiles();
});

$('#multiDownload').addEventListener('click', async ()=>{
  const checked = updateSelectionCount();
  if(!checked.length) return toast('No files selected');
  const files = [];
  for(const name of checked){
    const path = `${FOLDER}${name}`;
    if(DEMO_MODE){
      // create blob placeholder
      files.push({ name, blob: new Blob([`Demo file: ${name}`], { type:'text/plain' }) });
    } else {
      const url = await supabaseGetPublicUrl(path);
      if(url){
        try{
          const res = await fetch(url);
          const blob = await res.blob();
          files.push({ name, blob });
        }catch(e){ console.error('fetch fail', e); }
      }
    }
  }
  if(files.length) zipAndDownload(files);
});

/* ========== 10) UI WIRING & CONTROLS ========== */
function setupUI(){
  $('#loginBtn').addEventListener('click', ()=> {
    const val = $('#viewId').value.trim();
    if(val === VIEW_ID){ sessionStorage.setItem('loggedIn','true'); $('#loginPage').style.display='none'; $('#appPage').style.display='block'; listFiles(); }
    else showLoginError('Incorrect ID');
  });

  $('#chooseBtn').addEventListener('click', ()=> $('#fileInput').click());
  $('#uploadBtn').addEventListener('click', ()=> {
    const files = $('#fileInput').files;
    if(files && files.length){
      for(const f of files) enqueueUpload(f);
    } else $('#fileInput').click();
  });
  $('#fileInput').addEventListener('change', (e)=> { const fl = e.target.files; if(fl && fl.length){ for(const f of fl) enqueueUpload(f); } });

  $('#refreshBtn').addEventListener('click', ()=> listFiles());

  $('#settingsBtn').addEventListener('click', ()=> { $('#settingsPanel').classList.toggle('open'); $('#settingsPanel').setAttribute('aria-hidden', $('#settingsPanel').classList.contains('open') ? 'false' : 'true'); });
  $('#closeSettings').addEventListener('click', ()=> { $('#settingsPanel').classList.remove('open'); });

  $('#logoutBtn').addEventListener('click', ()=> {
    sessionStorage.removeItem('loggedIn'); $('#appPage').style.display='none'; $('#loginPage').style.display='flex'; $('#viewId').value='';
  });

  // Paste HTML controls
  $('#pasteHtmlBtn').addEventListener('click', ()=> openPasteModal());
  $('#closePaste').addEventListener('click', ()=> closePasteModal());
  $('#savePaste').addEventListener('click', ()=> savePastedHtml());
  $('#previewPaste').addEventListener('click', ()=> previewPastedHtml());

  // settings UI
  document.querySelectorAll('.theme-option').forEach(el=>{
    el.addEventListener('click', ()=>{ document.querySelectorAll('.theme-option').forEach(x=>x.classList.remove('active')); el.classList.add('active'); SETTINGS.theme = el.dataset.theme; applySettings(SETTINGS); });
  });
  $('#accentColor').addEventListener('input', (e)=> { SETTINGS.accent = e.target.value; applySettings(SETTINGS); });
  $('#toggleRadius').addEventListener('change', (e)=> { SETTINGS.radiusOn = e.target.checked; applySettings(SETTINGS); });
  $('#toggleGlow').addEventListener('change', (e)=> { SETTINGS.glowOn = e.target.checked; applySettings(SETTINGS); });
  $('#compactToggle').addEventListener('change', (e)=> { SETTINGS.compactMode = e.target.checked; applySettings(SETTINGS); });
  $('#saveSettings').addEventListener('click', ()=> { saveSettings(SETTINGS); alert('Settings saved'); $('#settingsPanel').classList.remove('open'); });
  $('#exportSettings').addEventListener('click', ()=> { const blob = new Blob([JSON.stringify(SETTINGS, null, 2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'my_storage_settings.json'; a.click(); URL.revokeObjectURL(url); });
  $('#importSettings').addEventListener('click', ()=> {
    const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json';
    input.onchange = (ev)=> {
      const f = ev.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> {
        try{ const j = JSON.parse(reader.result); SETTINGS = {...defaultSettings, ...j}; saveSettings(SETTINGS); applySettings(SETTINGS); populateSettingsUI(SETTINGS); alert('Settings imported'); }
        catch(e){ alert('Import failed'); }
      };
      reader.readAsText(f);
    };
    input.click();
  });

  // demo toggle
  $('#demoToggle').addEventListener('click', ()=> { SETTINGS.demoMode = !SETTINGS.demoMode; DEMO_MODE = SETTINGS.demoMode; saveSettings(SETTINGS); listFiles(); toast(`Demo mode ${DEMO_MODE?'ON':'OFF'}`); });

  // drop zone
  let dropShown = false;
  $('#dropZoneToggle').addEventListener('click', ()=> {
    dropShown = !dropShown;
    $('#dropZone').style.display = dropShown ? 'block' : 'none';
  });
  const dz = $('#dropZone');
  ['dragenter','dragover'].forEach(ev => {
    dz.addEventListener(ev, (e)=> { e.preventDefault(); dz.style.opacity = '1'; });
  });
  ['dragleave','drop'].forEach(ev => {
    dz.addEventListener(ev, (e)=> { e.preventDefault(); dz.style.opacity = '0.8'; });
  });
  dz.addEventListener('drop', (e)=> {
    e.preventDefault();
    const dt = e.dataTransfer;
    if(dt && dt.files && dt.files.length){
      for(const f of dt.files) enqueueUpload(f);
    }
  });

  // search debounce
  $('#search').addEventListener('input', debounce(()=>{ currentPage = 1; listFiles(); }, 300));
  $('#typeFilter').addEventListener('change', ()=> { currentPage=1; listFiles(); });
  $('#sortSelect').addEventListener('change', ()=> { currentPage=1; listFiles(); });

  // file list right-click context menu
  document.addEventListener('contextmenu', (e)=>{
    const card = e.target.closest('.file-card');
    if(card){
      e.preventDefault();
      const menu = $('#ctxMenu'); menu.innerHTML = '';
      const name = card.dataset.name;
      const items = [
        {label:'Download', action:()=> { const url = card.querySelector('.download')?.dataset.url || ''; if(url) window.open(url,'_blank'); }},
        {label:'Rename', action:()=> renameFile(name)},
        {label:'Delete', action:()=> deleteFile(name)},
        {label:'Copy URL', action:()=> copyToClipboard(card.querySelector('.download')?.dataset.url || '')},
        {label:'Details', action:()=> showDetails(name)}
      ];
      items.forEach(it=>{
        const el = document.createElement('div'); el.style.padding='6px 10px'; el.style.cursor='pointer'; el.textContent = it.label;
        el.addEventListener('click', ()=>{ it.action(); menu.style.display='none'; });
        menu.appendChild(el);
      });
      menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px'; menu.style.display = 'block';
    }
  });
  document.addEventListener('click', ()=> { $('#ctxMenu').style.display = 'none'; });

  // selection count updates when page changes
  document.addEventListener('change', (e)=> { if(e.target.matches('#fileList input[type="checkbox"]')) updateSelectionCount(); });

  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.key === '/') { e.preventDefault(); $('#search').focus(); }
    if(e.key === 'n' && e.ctrlKey) { e.preventDefault(); $('#fileInput').click(); }
    if(e.key === 'Delete' || e.key === 'Backspace'){ const sel = updateSelectionCount(); if(sel.length) { if(confirm('Delete selected?')) { $('#multiDelete').click(); } } }
  });
}

/* ========== 11) PASTE HTML HANDLING ========== */
function openPasteModal(){ $('#pasteArea').value = ''; $('#pasteFilename').value=''; $('#pastePreviewFrame').style.display='none'; $('#pasteModal').style.display='block'; $('#pasteArea').focus(); }
function closePasteModal(){ $('#pasteModal').style.display='none'; $('#pastePreviewFrame').style.display='none'; }
async function savePastedHtml(){
  const html = $('#pasteArea').value; let filename = ($('#pasteFilename').value || '').trim();
  if(!html || html.trim()===''){ alert('Paste some HTML first'); return; }
  if(!filename){ const m = html.match(/<title>([^<]+)<\/title>/i); filename = m ? m[1].trim().replace(/[^\w\-\. ]/g,'_') + '.html' : `pasted-${Date.now()}.html`; }
  if(!filename.toLowerCase().endsWith('.html')) filename = filename + '.html';
  const blob = new Blob([html], { type:'text/html' });
  const file = new File([blob], filename, { type:'text/html' });
  enqueueUpload(file);
  closePasteModal();
}
function previewPastedHtml(){ const html = $('#pasteArea').value || ''; const frame = $('#pastePreviewFrame'); frame.style.display = html.trim() ? 'block' : 'none'; if(!html.trim()){ frame.srcdoc=''; return; } frame.srcdoc = sanitizeHtmlForPreview(html); }
function sanitizeHtmlForPreview(html){ // minimal sanitization: strip script tags
  return html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'');
}

/* ========== 12) DETAILS, FAVORITES, TAGS (lightweight) ========== */
function showDetails(name){
  const f = (lastFetchedFiles||[]).find(x=>x.name===name) || { name, size:0, created_at:new Date().toISOString(), metadata:{} };
  const content = $('#detailsContent');
  content.innerHTML = `<div><strong>Name:</strong> ${f.name}</div><div><strong>Size:</strong> ${fmtBytes(f.size||0)}</div><div><strong>Created:</strong> ${fmtDate(f.created_at||new Date().toISOString())}</div><div style="margin-top:8px"><strong>Tags:</strong> ${(f.metadata?.tags||[]).join(', ')}</div>`;
  $('#detailsModal').style.display = 'block';
}

/* ========== 13) INIT & BOOT ========== */
applySettings(SETTINGS);
populateSettingsUI(SETTINGS);
setupUI();

// auto-login if session present
const logged = sessionStorage.getItem('loggedIn') === 'true' || sessionStorage.getItem('loggedIn') === 'demo';
if(logged){ $('#loginPage').style.display='none'; $('#appPage').style.display='block'; listFiles(); }
else { $('#loginPage').style.display='flex'; $('#appPage').style.display='none'; }

// save settings on unload
window.addEventListener('beforeunload', ()=> { saveSettings(SETTINGS); });

/* expose debug helpers */
window._myStorage = { SETTINGS, listFiles, enqueueUpload, processQueue, genDemoFiles, zipAndDownload, supabaseGetPublicUrl };

</script>

<!-- background controllers - kept as before (particles/waves) -->
<script>
(function(){
  const canvas = document.getElementById('bgCanvas');
  const ctx = canvas.getContext('2d', { alpha:true });
  let DPR = Math.max(1, window.devicePixelRatio || 1);
  let W = innerWidth, H = innerHeight;
  let pts = [];
  let density = parseInt(document.getElementById('particleRange')?.value || 120,10) || 120;
  let running = true;
  let mouse = { x:-9999, y:-9999, active:false };
  function resize(){ W = innerWidth; H = innerHeight; canvas.width = W * DPR; canvas.height = H * DPR; canvas.style.width = W + 'px'; canvas.style.height = H + 'px'; ctx.setTransform(DPR,0,0,DPR,0,0); createPoints(); }
  function rand(a,b){ return Math.random()*(b-a)+a; }
  function createPoints(){ pts = []; const base = Math.max(30, Math.min(420, Math.round(density * ((W*H)/(1366*768))))); for(let i=0;i<base;i++) pts.push({ x:rand(0,W), y:rand(0,H), vx:rand(-0.35,0.35), vy:rand(-0.35,0.35), r:rand(0.8,1.8) }); }
  function step(){ if(!running){ requestAnimationFrame(step); return; } ctx.clearRect(0,0,W,H); for(const p of pts){ p.x += p.vx; p.y += p.vy; if(p.x < -30) p.x = W + 30; if(p.x > W + 30) p.x = -30; if(p.y < -30) p.y = H + 30; if(p.y > H + 30) p.y = -30; } for(let i=0;i<pts.length;i++){ for(let j=i+1;j<pts.length;j++){ const a=pts[i], b=pts[j]; const dx=a.x-b.x, dy=a.y-b.y; const d=Math.sqrt(dx*dx+dy*dy); if(d < 140){ let alpha = 0.22*(1 - d/140); if(mouse.active){ const mx=(a.x+b.x)/2 - mouse.x, my=(a.y+b.y)/2 - mouse.y; const md=Math.sqrt(mx*mx+my*my); if(md < 220) alpha += (1 - md/220)*0.35; } ctx.strokeStyle = `rgba(255,255,255,${alpha.toFixed(3)})`; ctx.lineWidth = 0.9; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); } } } for(const p of pts){ let size = p.r; if(mouse.active){ const dx=p.x-mouse.x, dy=p.y-mouse.y; const d=Math.sqrt(dx*dx+dy*dy); if(d < 200){ const push=(200-d)/200; p.x += (dx/d||0)*push*1.8; p.y += (dy/d||0)*push*1.8; size = p.r + push*1.6; } } ctx.beginPath(); ctx.fillStyle = `rgba(255,255,255,${0.85 - size*0.25})`; ctx.arc(p.x,p.y,size,0,Math.PI*2); ctx.fill(); } requestAnimationFrame(step); }
  window.addEventListener('resize', resize);
  window.addEventListener('mousemove', (e)=>{ mouse.x = e.clientX; mouse.y = e.clientY; mouse.active = true; });
  window.addEventListener('mouseout', ()=>{ mouse.active = false; mouse.x = -9999; mouse.y = -9999; });
  window.Particles = { start(){ running = true; }, stop(){ running = false; ctx.clearRect(0,0,W,H); }, setDensity(n){ density = n; createPoints(); }, getDensity(){ return density; } };
  resize(); step();
})();
</script>
</body>
</html>
